---
title: "01 Data Processing"
author: "Paul Renauer"
date: "2025-08-14"
description: "This code includes data preprocessing and processing steps.
Briefly, datasets are filtered, integrated, and reduced to 2-dimensions by UMAP.
Cells are then annotated and population sizes are compared by summary-level 
statistics."
output: html_document
---

```{r include = FALSE}
knitr::opts_chunk$set(message = F, eval=F)
```

### Load libraries and prepare environment
```{r Setup environment}

setwd('6_SCT')
# Common libraries
library(dplyr)
library(stringr)
library(data.table)
library(ggplot2)
library(ggrepel)
library(ggrastr)
library(Matrix)
library(reticulate)
library(Seurat)
library(future)
# Library for SCT data integration
library(rliger)


## Source file with accessory functions
source('00_Additional_Functions.R')


## Set options
options(future.globals.maxSize= 10000*1024^2)
options(matrixStats.useNames.NA = 'deprecated')
options("ggrastr.default.dpi" = 750)

```


### Setup Seurat Object (SO)
```{r Setup Seurat Object (SO)}

## Create merged matrix 
rawDataPaths <- dir('Datasets/CellRanger', recursive=F, full.names=T)
rawDataPaths <- paste0(rawDataPaths, '/filtered_feature_bc_matrix')
m <- Read10X(rawDataPaths[1])
m <- combineMatrices(m, Read10X(rawDataPaths[2]), paste0('-',2))


## Create Seurat Object
so <- CreateSeuratObject(counts=m, min.cells = 3, min.features=200)
rm(m)
so$Percent.mt <- PercentageFeatureSet(so, pattern = '^MT-')
so$Low_Quality <- PercentageFeatureSet(so, features = c('MALAT1', 'KCNQ1OT1'))
so <- subset(so, subset = Percent.mt < 20 & Low_Quality < 5)
# Add info to so
samples <- c('OR7A10_Tumor', 'OR7A10st_Tumor')
so$sample <- samples[as.integer(str_split_i(colnames(so), '-', 2))]

```

### Integrate sample datasets
```{r Integrate sample datasets}

## Run Liger iNMF integration
gc()
plan('sequential')
so <- rliger::normalize(so) 
so <- selectGenes(so, datasetVar='sample', thresh=0.1)
so <- scaleNotCenter(so, datasetVar='sample')
so <- runINMF(so, datasetVar='sample', k = 20, nCores=20, lambda=10)
so <- alignFactors(so, method = "centroidAlign")


## Dimensional reduction
plan('multicore')
so <- RunUMAP(so, reduction = "inmfNorm", dims = 1:20,min.dist=0.01,seed.use=42)


# add umap coords to metadata
so$x <- so$umap@cell.embeddings[,1]
so$y <- so$umap@cell.embeddings[,2]
so <- FindNeighbors(so, reduction='inmfNorm', dims=1:20, l2.norm=T, 
                    graph.name=c('RNA_nn','RNA_snn'))

## Save data
saveRDS(so, 'Datasets/so_unproc.rds')

```


### Find and exclude tumor cells
```{r Find and exclude tumor cells}

## Visualize bulk NK and tumor cells populations on UMAP
p <- FeaturePlot(so,c('EGFR','EPCAM','KRT18','KRT19'), pt.size=5, order=T, raster=T)
ggsave(plot=p, 'Figures/01_tumorRemoval_umap_v0.1.pdf', height=2.5*2, width=2.9*2,
       scale=1.5)
# check EGFR, EPCAM, KRT18, KRT19 also

## remove tumor cells
# exclude tumor cells
so <- subset(so, subset=(y > -9))

```

### Cluster cells
```{r Cluster cells}

## calculate snn graph
so <- FindNeighbors(so, reduction='umap', dims=1:2, 
                    graph.name=c('RNA_nn','RNA_snn'))
## calculate optimal clustering resolution
plan('sequential')
oc <- DetermineOptimalClusters(so, graph.name='RNA_snn', resolution=seq(0.05,0.3,0.01))
oc$plot
oc <- DetermineOptimalClusters(so, graph.name='RNA_snn', resolution=seq(0.1,0.15,0.002))
oc$plot
so <- FindClusters(so, graph.name = 'RNA_snn', algorithm = 4, resolution = 0.116, random.seed = 42, cluster.name='clust_numbered') 

## Save data
saveRDS(so, 'Datasets/so_proc1.rds')

```


### Classify iNK/mNK cell populations
```{r Classify iNK/mNK cell populations}

## Make umap heat map of markers for iNK/mNK distinction
p1 <- FeaturePlot(so, raster=T, order=T, raster.dpi = c(750, 750), 
                  max.cutoff='q99', 'NCAM1', pt.size=4.5) + 
  scale_color_viridis()
p2 <- FeaturePlot(so, raster=T, order=T, raster.dpi = c(750, 750),                  
                  max.cutoff='q90', 'FCGR3A', pt.size=4.5) + 
  scale_color_viridis()
ggsave(plot=p1 | p2, 'Figures/featPlot_markers_v0.1.pdf', 
       height=2.5*1, width=2.9*2, scale=1.5)


## Generate marker list from top 10 upreg. genes of Tang_Cell2023 paper.
DefaultAssay(so) <- 'RNA'
subset.markerlist <- read.delim('Data/01_cellmarker_list_Tang_Cell2023.txt')
function.markerlist <- do.call(rbind, list(
    data.frame(subset='inhib.hla.dep', marker=c('KIR2DL1', 'KIR2DL3', 'KIR3DL1',
                                                'KIR3DL2', 'LILRB1', 'LAG3')),
    data.frame(subset='inhib.hla.indep',marker=c('PDCD1', 'SIGLEC7', 'CD300A', 
                                                 'CD96', 'IL1RAPL1', 'TIGIT',
                                                 'HAVCR2')),
    data.frame(subset='activ.hla.dep', marker=c('KIR2DL4', 'CD160', 'KLRC2')),
    data.frame(subset='activ.hla.indep', marker=c('NCR3', 'NCR1', 'KLRK1', 
                                                  'CRTAM', 'FCGR3A', 'HCST')),
    data.frame(subset='coreceptors', marker=c('CD226', 'SLAMF6', 'SLAMF7', 
                                              'CD244', 'TNFRSF9', 'CD59')),
    data.frame(subset='cytotoxicity', marker=c('GZMA', 'GZMB', 'GZMH', 'GZMM', 
                                               'GZMK', 'GNLY', 'PRF1', 'CTSW')),
    data.frame(subset='inflammatory', marker=c('CCL2', 'CCL3', 'CCL4', 'CCL5', 
                                               'CXCL10', 'CXCL9', 'IL1B', 'IL6', 
                                               'IL7', 'IL15', 'IL18')),
    data.frame(subset='stress', marker=c('BAG3', 'CALU', 'DNAJB1', 'DUSP1', 
                                         'EGR1', 'FOS', 'FOSB', 'HIF1A', 
                                         'HSP90AA1', 'HSP90AB1', 'HSP90B1', 
                                         'HSPA1A', 'HSPA1B', 'HSPA6', 'HSPB1', 
                                         'HSPH1', 'IER2', 'JUN','JUNB','NFKBIA', 
                                         'NFKBIZ', 'RGS2', 'SLC2A3', 'SOCS3', 
                                         'UBC', 'ZFAND2A', 'ZFP3', 'ZFP36L1'))
))
mlist <- rbind(subset.markerlist, function.markerlist)
mlist <- lapply(unique(mlist$subset), function(x){ 
    return(mlist$marker[which(mlist$subset==x)])
}) %>% structure(names= unique(mlist$subset))
names(mlist) <- str_replace(names(mlist), '-', '_')


## Generate signature scores for NK subsets
hvg <- intersect(VariableFeatures(so$RNA), unique(unlist(mlist)))
m <- so$RNA$data[hvg,]
library(AUCell)
m2 <- AUCell_buildRankings(
    exprMat=m,
    featureType = "genes",
    splitByBlocks = TRUE,
    BPPARAM = BiocParallel::MulticoreParam(tasks=100, force.GC=T, progressbar=T),
    verbose = T)
m <- AUCell_calcAUC(mlist, m2, nCores=20, verbose=T)
saveRDS(m, 'Datasets/aucell_subsetMarkerSignatures.rds')
rm(m2)


## Add signatures to SO
m <- t(m@assays@data$AUC[, colnames(so)])
so@meta.data <- cbind(so@meta.data, m)

```


### Make dot plots of markers and signatures to characterize clusters 
```{r Make dot plots of markers and signatures to characterize clusters }

## Make list of custom dot plots
p <- list(
    # Plot of general markers
    customDotPlot(so, c('NCAM1','FCGR3A','KLRF1','RGS1'),
                  group.by='clust_numbered', scale.max=50),
    # Plot of major cell populations
    customDotPlot(so, grep('^CD56', names(mlist), invert=T,value=T),
                  group.by='clust_numbered', scale.max=50),
    customDotPlot(so, c('KLRC2','IL32','CX3CR1','BATF3','MKI67',
                        'EGR2','PRF1','GZMB','CREM'),
                  group.by='clust_numbered', scale.max=50)
)
p <- cowplot::plot_grid(plotlist=p, align='h', axis='lbt', nrow=1, 
                        rel_widths=c(0.4,1,0.6,0.7))
ggsave(plot=p, 'Figures/dotplot_celltypes_clusters_v0.1.pdf', 
       height=3.7*1, width=1.7*4,scale=1.5)

```


### Name clusters
```{r Name clusters}

## Name clusters
so$ct <- c('mNK_c5-KLRC2','mNK_c3-BATF3','mNK_c1-MKI67','mNK_c2-MKI67-BATF3','mNK_c6-EGR2',
               'mNK_c4-IL32','iNK_c1-Cytotoxic','iNK_c2-CREM')[as.integer(so$clust_numbered)]
## Create grouped subsets
so$nk_type <- str_split_i(so$ct,'_',1)
Idents(so) <- so$ct


## Save data
saveRDS(so, 'Datasets/so_proc2.rds')

```


### Visualize marker genes and signatures across cell subsets
```{r Visualize marker genes and signatures across cell subsets}

## Make dot plots across subsets
# Reorder celltype factor for plots
group.order <- rev(sort(unique(so$ct)))
# Make list of custom dot plots
p <- list(
    # Plot of general markers
    customDotPlot(so, c('NCAM1','FCGR3A','KLRF1','RGS1',
                        grep('^CD56', names(mlist), invert=T, value=T)),
                  group.order=group.order, group.by='ct', scale.max=50),
    # Plot of iNK markers
    customDotPlot(so, c('cytotoxicity', 'PRF1','CREM','stress'),
                  group.order=group.order, group.by='ct', scale.max=50),
    # Plot of mNK markers
    customDotPlot(so, c('MKI67', 'BATF3', 'IL32','KLRC2','EGR2'),
                  group.order=group.order, group.by='ct', scale.max=50)
)
p <- cowplot::plot_grid(plotlist=p, align='h', axis='lbt', nrow=1,rel_widths=c(1,0.7,0.7))
ggsave(plot=p, 'Figures/dotplot_celltypes_ct_v0.1.pdf', 
       height=2.75*1, width=2.5*3,scale=1.5)


## Make dot plots across subsets and Genotypes
# Make ID with subset and genotype
so$id <- paste0(so$ct, ':', (str_replace(so$sample, 'st','stop') %>% 
                  str_remove('_Tumor')))
p <- list(
  # Plot of general markers
  customDotPlot(so, c('NCAM1','FCGR3A','KLRF1','RGS1',
                      grep('^CD56', names(mlist), invert=T, value=T)),
                group.order=rev(sort(unique(so$id))), group.by='id', scale.max=50),
  # Plot of iNK markers
  customDotPlot(so, c('cytotoxicity', 'PRF1','CREM','stress'),
                group.order=rev(sort(unique(so$id))), group.by='id', scale.max=50),
  # Plot of mNK markers
  customDotPlot(so, c('MKI67', 'BATF3', 'IL32','KLRC2','EGR2'),
                group.order=rev(sort(unique(so$id))), group.by='id', scale.max=50)
)
p <- cowplot::plot_grid(plotlist=p, align='h', axis='lbt', nrow=1,rel_widths=c(1,0.75,0.75))
ggsave(plot=p, 'Figures/dotplot_celltypes_ct-geno_v0.1.pdf', 
       height=4*1, width=3.1*3,scale=1.5)



## Dot plots of signatures genes across celltypes
p <- customDotPlot(so, as.character(unlist(mlist[grep('^CD56', names(mlist), invert=T,value=T)])),
                    group.order=group.order, group.by='ct', scale.max=20)
ggsave(plot=p, 'Figures/dotplot_celltypes_allGenes_v0.1.pdf', 
       height=2.75*1, width=12*1,scale=1.5)
p <- customDotPlot(so, as.character(unlist(mlist[grep('^CD56', names(mlist), invert=T,value=T)])),
                   group.order=rev(sort(unique(so$id))), group.by='id', scale.max=20)
ggsave(plot=p, 'Figures/dotplot_celltypes-geno_allGenes_v0.1.pdf', 
       height=3.5*1, width=13*1,scale=1.5)

```


### Make subset-labeled UMAPs
```{r Make subset-labeled UMAPs}

## get coordinates for cluster labels
centroids <- reframe(so@meta.data, .by=c('ct'), label=ct[1], x=mean(x), y=mean(y))
p1 <- ggplot(so@meta.data, aes(x=x,y=y)) +
    ggrastr::geom_point_rast(size=2,color='gray25') +
    ggrastr::geom_point_rast(size=0.75, aes(color=ct)) + theme_void() +
    ggrepel::geom_text_repel(data=centroids, aes(x=x,y=y,label=label),
                             min.segment.length = 0) +
    theme(legend.position='none')
cols <- structure(ggcolor(8), names=sort(unique(so$ct)))
p2 <- lapply(unique(so$sample), function(samples){
    d <- so@meta.data[which(so$sample==samples),]
    centroids <- reframe(d, .by=c('ct'), label=ct[1], x=mean(x), y=mean(y))
    ggplot(d, aes(x=x,y=y)) + theme_void() +
        ggrastr::geom_point_rast(data=so@meta.data,size=1,color='gray25') +
        ggrastr::geom_point_rast(data=so@meta.data,size=0.25, color='gray98') + 
        ggrastr::geom_point_rast(size=1,color='gray25') +
        ggrastr::geom_point_rast(size=0.25, aes(color=ct)) + 
        labs(title=samples) +
        scale_color_manual(values=cols) + 
        theme(legend.position='none', title=element_text(vjust=0.25))
})
p2 <- cowplot::plot_grid(plotlist=p2, align='hv', axis='lb', ncol=1)
p <- cowplot::plot_grid(p1,p2, align='hv', axis='lb', ncol=2, rel_widths=c(1,0.6))
ggsave(plot=p, 'Figures/umap_celltypes_samples_v0.1.pdf', height=3*1, width=2.5*2)

```


### Compare distributions of cell subsets
```{r Compare distributions of cell subsets}

## Make bar plots for subsets
d <- so@meta.data[,c('ct', 'nk_type', 'sample')]
d <- mutate(d, .by=c('sample'), total=length(sample))
d <- reframe(d, .by=c('ct','sample'), pct=length(ct)/total[1])
d$sample <- str_split_i(d$sample, '_',1) %>% str_replace(., 'st','stop')
d$sample <- factor(d$sample, levels=sort(unique(d$sample)))
celltypes <- sort(unique(so$ct))
d$ct <- factor(d$ct, levels=(celltypes))
cols <- structure(ggcolor(8), names=levels(d$ct))
p1 <- ggplot(d, aes(y=sample, x=pct, fill=ct)) + 
    geom_bar(stat='identity', position='stack', color='gray20') +
  theme_classic() + scale_fill_manual(values=cols) +
    labs(y=NULL, x=('Proportion of NK cells')) + #coord_flip()+
    theme(legend.key.spacing=unit(0.5,'lines'), #legend.position='bottom', 
          legend.key.size = unit(0.9, 'lines'),
          legend.key.height=unit(0.5,'lines'), legend.key.width=unit(0.5,'lines'), 
          legend.text=element_text(size=7), legend.key.spacing.y=unit(0.01,'lines'),
          #axis.text.x=element_text(angle=90, hjust=1, vjust=0.5),
          legend.title=element_text(size=10))
d <- so@meta.data[,c('ct', 'nk_type', 'sample')]
d <- mutate(d, .by=c('sample'), total=length(sample))
d <- reframe(d, .by=c('ct','sample'), pct=length(ct)/total[1])
d$ct <- factor(d$ct, levels=sort(celltypes))
d$sample <- factor(d$sample, levels=rev(samples))
cols <- structure(c('#B2B2B2','#E9AC4C'),
                  names=rev(samples))
xlabs <- paste0(substr(celltypes, 0,6),'\n',substr(celltypes, 8,100))
names(xlabs) <- celltypes
p2 <- ggplot(d, aes(x=ct, y=pct, fill=sample)) + 
    geom_bar(stat='identity', position='dodge', color='gray20') + theme_classic() +
    scale_fill_manual(values=cols) + scale_x_discrete(labels=xlabs) +
    labs(x=NULL, y=str_wrap('Proportion of NK cells')) + #coord_flip()+
    theme(legend.key.spacing=unit(0.5,'lines'), #legend.position='bottom', 
          legend.key.size = unit(0.9, 'lines'),
          axis.text.x=element_text(lineheight=0.75),
          legend.key.height=unit(0.5,'lines'), legend.key.width=unit(0.5,'lines'), 
          legend.text=element_text(size=7), legend.key.spacing.y=unit(0.01,'lines'),
          #axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5),
          legend.title=element_text(size=10))
p <- cowplot::plot_grid(p1,p2, ncol=1, align='hv', axis='lbt', rel_heights=c(0.75,1))
ggsave(plot=p, 'Figures/barplot_subset_pct_v0.2.pdf', height=1.2*2, width=8)


## Stats for subset proportions between genotypes
library(rstatix)
d <- so@meta.data[ ,c( 'ct', 'sample')]
d <- reframe(d, .by=c('ct','sample'), x=length(ct))
d <- mutate(d, .by='sample', total=sum(x))
d$y <- d$total - d$x
d$p <- d$x/d$total
rownames(d) <- paste0(d$sample,'_',d$ct)
r <- do.call(rbind, lapply(celltypes, function(ct){
    if(ct=='CD4_TCM') return(NULL)
    r <- pairwise_fisher_test(d[which(d$ct==ct), c('x','y')])
    return(data.frame(ct=ct, r[,1:4]))
}))
r$p.adj <- p.adjust(r$p)
r <- r[order(r$ct),-4]
r$signif <- case_when(r$p.adj < 1e-4 ~ '****',
                      r$p.adj < 1e-3 ~ '***',
                      r$p.adj < 1e-2 ~ '**',
                      r$p.adj < 0.05 ~ '*',
                      r$p.adj >= 0.05 ~'ns')
write.table(r, 'Data/subset_pct_comp.txt', sep='\t', quote=F, row.names=F)

```

### Cell cycle analysis
```{r Cell cycle analysis}

## Cell cycle scoring
so <- CellCycleScoring(so, s.features = cc.genes$s.genes, 
                       g2m.features = cc.genes$g2m.genes, set.ident = F)

## Make umap to display cellcycle phase
centroids <- reframe(so@meta.data, .by='Phase', label=Phase[1], 
                     x=mean(x), y=mean(y))
p <- ggplot(so@meta.data, aes(x=x,y=y)) +
  ggrastr::geom_point_rast(size=2,color='gray25') +
  ggrastr::geom_point_rast(size=0.75, aes(color=Phase)) + theme_void() +
  ggrepel::geom_text_repel(data=centroids, aes(x=x,y=y,label=label),
                           min.segment.length = 0) +
  theme(legend.position='bottom')
ggsave(plot=p, 'Figures/umap_cellcycle_v0.1.pdf', height=2.5*1, width=2.5*1)

```
